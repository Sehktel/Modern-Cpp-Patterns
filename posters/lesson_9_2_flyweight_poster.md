# 📊 Плакат: Flyweight Pattern

## 🎯 Концепция Flyweight

```
┌─────────────────────────────────────────────────────────────────┐
│                     FLYWEIGHT PATTERN                          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  💾 МИНИМИЗАЦИЯ ПОТРЕБЛЕНИЯ ПАМЯТИ                             │
│  🔄 РАЗДЕЛЕНИЕ ОБЩЕГО СОСТОЯНИЯ МЕЖДУ ОБЪЕКТАМИ                │
│  ⚡ ПОДДЕРЖКА БОЛЬШОГО КОЛИЧЕСТВА ОБЪЕКТОВ                     │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┬───────────────────────────────────────────────┐
│   ПРОБЛЕМА      │  • Много похожих объектов                     │
│                 │  • Каждый хранит дублирующиеся данные         │
│                 │  • Огромное потребление памяти                │
│                 │  • Медленная работа из-за cache misses        │
├─────────────────┼───────────────────────────────────────────────┤
│   РЕШЕНИЕ       │  • Intrinsic state: разделяемое состояние     │
│                 │  • Extrinsic state: уникальное состояние      │
│                 │  • Flyweight Factory для управления           │
│                 │  • Один объект → много ссылок                 │
└─────────────────┴───────────────────────────────────────────────┘
```

## 🧩 Разделение состояния

```
┌─────────────────────────────────────────────────────────────────┐
│          INTRINSIC vs EXTRINSIC STATE                          │
└─────────────────────────────────────────────────────────────────┘

БЕЗ FLYWEIGHT (Каждый символ хранит все):
┌─────────────────────────────────────────────────────────────────┐
│  Character 'A':                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ char = 'A'           (1 byte)                            │  │
│  │ font = "Arial"       (40 bytes - string)                 │  │
│  │ size = 12            (4 bytes)                           │  │
│  │ color = "Black"      (40 bytes - string)                 │  │
│  │ bold = false         (1 byte)                            │  │
│  │ italic = false       (1 byte)                            │  │
│  │ position_x = 10      (4 bytes)                           │  │
│  │ position_y = 20      (4 bytes)                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│  Total: ~95 bytes PER CHARACTER!                                │
│                                                                 │
│  10,000 символов × 95 bytes = 950 KB 😱                       │
└─────────────────────────────────────────────────────────────────┘

С FLYWEIGHT (Разделение состояния):
┌─────────────────────────────────────────────────────────────────┐
│  INTRINSIC STATE (Разделяемое - Flyweight):                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ CharacterStyle (ONE instance for many 'A's):             │  │
│  │ ┌────────────────────────────────────────────────────┐   │  │
│  │ │ font = "Arial"       (40 bytes)                    │   │  │
│  │ │ size = 12            (4 bytes)                     │   │  │
│  │ │ color = "Black"      (40 bytes)                    │   │  │
│  │ │ bold = false         (1 byte)                      │   │  │
│  │ │ italic = false       (1 byte)                      │   │  │
│  │ └────────────────────────────────────────────────────┘   │  │
│  │ Total: 86 bytes (shared by ALL characters with style)    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  EXTRINSIC STATE (Уникальное - на каждый символ):              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Character 'A':                                           │  │
│  │ ┌────────────────────────────────────────────────────┐   │  │
│  │ │ char = 'A'           (1 byte)                      │   │  │
│  │ │ style_ptr            (8 bytes - pointer)           │   │  │
│  │ │ position_x = 10      (4 bytes)                     │   │  │
│  │ │ position_y = 20      (4 bytes)                     │   │  │
│  │ └────────────────────────────────────────────────────┘   │  │
│  │ Total: 17 bytes per character                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  10,000 символов × 17 bytes + 86 bytes (style) ≈ 170 KB       │
│                                                                 │
│  ЭКОНОМИЯ: 950 KB → 170 KB = 82% меньше памяти! 🚀            │
└─────────────────────────────────────────────────────────────────┘
```

## 🏗️ Архитектура Flyweight

```
┌─────────────────────────────────────────────────────────────────┐
│                 FLYWEIGHT ARCHITECTURE                         │
└─────────────────────────────────────────────────────────────────┘

                 ┌──────────────────────────┐
                 │   FLYWEIGHT FACTORY      │
                 │  (Управляет Flyweights)  │
                 │                          │
                 │  Map<Key, Flyweight>     │
                 │  "Arial_12_Black" → FW1  │
                 │  "Times_14_Blue"  → FW2  │
                 └──────────────────────────┘
                           │
                           │ getStyle(font, size, color)
                           ↓
            ┌──────────────────────────────────┐
            │  FLYWEIGHT (Shared State)        │
            │  ┌────────────────────────────┐  │
            │  │ font_family: "Arial"       │  │
            │  │ font_size: 12              │  │
            │  │ color: "Black"             │  │
            │  │ bold: false                │  │
            │  │ italic: false              │  │
            │  └────────────────────────────┘  │
            └──────────────────────────────────┘
                      ↑        ↑        ↑
                      │        │        │
            ┌─────────┴────────┴────────┴──────────┐
            │                                       │
   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐
   │ Character 'A'  │  │ Character 'B'  │  │ Character 'C'  │
   │ ┌────────────┐ │  │ ┌────────────┐ │  │ ┌────────────┐ │
   │ │char: 'A'   │ │  │ │char: 'B'   │ │  │ │char: 'C'   │ │
   │ │style: FW1──┼─┼──┼─┤style: FW1──┼─┼──┼─┤style: FW1──┼ │
   │ │pos_x: 10   │ │  │ │pos_x: 20   │ │  │ │pos_x: 30   │ │
   │ │pos_y: 5    │ │  │ │pos_y: 5    │ │  │ │pos_y: 5    │ │
   │ └────────────┘ │  │ └────────────┘ │  │ └────────────┘ │
   └────────────────┘  └────────────────┘  └────────────────┘
    
    Все три символа РАЗДЕЛЯЮТ один Flyweight object!
```

## 💡 Сравнение подходов

```
┌─────────────────────────────────────────────────────────────────┐
│           БЕЗ FLYWEIGHT vs С FLYWEIGHT                         │
└─────────────────────────────────────────────────────────────────┘

❌ БЕЗ FLYWEIGHT:
┌─────────────────────────────────────────────────────────────────┐
│ class Character {                                               │
│     char character_;                                            │
│     std::string font_family_;    // Дублируется!               │
│     int font_size_;              // Дублируется!               │
│     std::string color_;          // Дублируется!               │
│     bool bold_;                  // Дублируется!               │
│     bool italic_;                // Дублируется!               │
│     int position_x_;             // Уникально                   │
│     int position_y_;             // Уникально                   │
│ };                                                              │
│                                                                 │
│ std::vector<Character> text;                                    │
│ for (int i = 0; i < 10000; ++i) {                             │
│     text.emplace_back('A', "Arial", 12, "Black", false, false, │
│                       i * 10, 20);                              │
│ }                                                               │
│                                                                 │
│ // Каждый Character = ~95 bytes                                │
│ // 10,000 символов = 950 KB                                    │
│                                                                 │
│ ⚠️ ПРОБЛЕМЫ:                                                   │
│  • Огромное потребление памяти                                 │
│  • Много дублирующихся данных                                  │
│  • Cache misses (данные разбросаны)                            │
│  • Медленное копирование                                       │
└─────────────────────────────────────────────────────────────────┘

✅ С FLYWEIGHT:
┌─────────────────────────────────────────────────────────────────┐
│ // Разделяемое состояние                                        │
│ class CharacterStyle {                                          │
│     std::string font_family_;                                   │
│     int font_size_;                                             │
│     std::string color_;                                         │
│     bool bold_;                                                 │
│     bool italic_;                                               │
│ };                                                              │
│                                                                 │
│ // Уникальное состояние                                        │
│ class Character {                                               │
│     char character_;                                            │
│     std::shared_ptr<CharacterStyle> style_;  // Shared!        │
│     int position_x_;                                            │
│     int position_y_;                                            │
│ };                                                              │
│                                                                 │
│ CharacterStyleFactory factory;                                  │
│ auto style = factory.getStyle("Arial", 12, "Black", false, false);│
│                                                                 │
│ std::vector<Character> text;                                    │
│ for (int i = 0; i < 10000; ++i) {                             │
│     text.emplace_back('A', style, i * 10, 20);                 │
│ }                                                               │
│                                                                 │
│ // Каждый Character = ~17 bytes                                │
│ // 10,000 символов + 1 style = ~170 KB                         │
│                                                                 │
│ ✅ ПРЕИМУЩЕСТВА:                                               │
│  • 82% экономии памяти!                                        │
│  • Нет дублирования данных                                     │
│  • Лучшая cache locality                                       │
│  • Быстрое копирование (только указатель)                      │
└─────────────────────────────────────────────────────────────────┘
```

## 🔧 Реализация Flyweight Factory

```
┌─────────────────────────────────────────────────────────────────┐
│            FLYWEIGHT FACTORY IMPLEMENTATION                    │
└─────────────────────────────────────────────────────────────────┘

class CharacterStyle {
private:
    std::string font_family_;
    int font_size_;
    std::string color_;
    bool bold_;
    bool italic_;
    
public:
    CharacterStyle(const std::string& font, int size, 
                  const std::string& color, bool bold, bool italic)
        : font_family_(font), font_size_(size), color_(color),
          bold_(bold), italic_(italic) {}
    
    // Генерация уникального ключа
    std::string getKey() const {
        return font_family_ + "_" + std::to_string(font_size_) + 
               "_" + color_ + "_" + std::to_string(bold_) + 
               "_" + std::to_string(italic_);
    }
    
    void applyStyle() const {
        // Применить стиль к символу
    }
};

class CharacterStyleFactory {
private:
    std::unordered_map<std::string, 
                      std::shared_ptr<CharacterStyle>> styles_;
    mutable std::mutex mutex_;
    
public:
    std::shared_ptr<CharacterStyle> getStyle(
        const std::string& font, int size,
        const std::string& color, bool bold, bool italic) {
        
        std::lock_guard<std::mutex> lock(mutex_);
        
        // Создаем временный объект для получения ключа
        CharacterStyle temp(font, size, color, bold, italic);
        std::string key = temp.getKey();
        
        // Ищем существующий flyweight
        auto it = styles_.find(key);
        if (it != styles_.end()) {
            return it->second;  // Возвращаем существующий
        }
        
        // Создаем новый flyweight
        auto style = std::make_shared<CharacterStyle>(
            font, size, color, bold, italic);
        styles_[key] = style;
        
        std::cout << "Создан новый стиль: " << key 
                  << " (всего: " << styles_.size() << ")" << std::endl;
        
        return style;
    }
    
    size_t getStyleCount() const {
        std::lock_guard<std::mutex> lock(mutex_);
        return styles_.size();
    }
};

ИСПОЛЬЗОВАНИЕ:
┌─────────────────────────────────────────────────────────────────┐
│ CharacterStyleFactory factory;                                  │
│                                                                 │
│ // Создаем документ                                             │
│ std::vector<Character> document;                                │
│                                                                 │
│ // Все символы с одинаковым стилем РАЗДЕЛЯЮТ один Flyweight    │
│ auto style1 = factory.getStyle("Arial", 12, "Black", false, false);│
│                                                                 │
│ for (char c : "Hello World") {                                 │
│     document.emplace_back(c, style1, x++, y);                  │
│ }                                                               │
│                                                                 │
│ // Новый стиль создается только один раз                       │
│ auto style2 = factory.getStyle("Arial", 14, "Red", true, false);│
│ document.emplace_back('!', style2, x++, y);                    │
└─────────────────────────────────────────────────────────────────┘
```

## 🎯 Примеры использования

```
┌─────────────────────────────────────────────────────────────────┐
│                 РЕАЛЬНЫЕ ПРИМЕРЫ FLYWEIGHT                     │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  1. ТЕКСТОВЫЙ РЕДАКТОР                                          │
│     INTRINSIC:  Font, Size, Color, Style                        │
│     EXTRINSIC:  Character, Position                             │
│                                                                 │
│     10,000 символов, 5 разных стилей                           │
│     БЕЗ Flyweight: 10,000 × 95 bytes = 950 KB                  │
│     С Flyweight:   10,000 × 17 bytes + 5 × 86 = 170 KB        │
├─────────────────────────────────────────────────────────────────┤
│  2. ИГРОВОЙ ДВИЖОК (Particles)                                  │
│     INTRINSIC:  Texture, Shader, Material                       │
│     EXTRINSIC:  Position, Velocity, Rotation                    │
│                                                                 │
│     100,000 частиц, 10 типов                                   │
│     БЕЗ Flyweight: 100,000 × 1KB = 100 MB                      │
│     С Flyweight:   100,000 × 48 bytes + 10 × 1KB = 5 MB       │
├─────────────────────────────────────────────────────────────────┤
│  3. WEB БРАУЗЕР (DOM Nodes)                                     │
│     INTRINSIC:  CSS Class, Tag Name, Attributes                 │
│     EXTRINSIC:  Content, Children, Position                     │
│                                                                 │
│     1,000 <div> элементов с 5 разными классами                 │
│     Flyweight для CSS properties                                │
├─────────────────────────────────────────────────────────────────┤
│  4. ИГРА (Tile Map)                                             │
│     INTRINSIC:  Tile Sprite, Properties                         │
│     EXTRINSIC:  Grid Position                                   │
│                                                                 │
│     1000×1000 тайлов, 50 разных типов                          │
│     БЕЗ Flyweight: 1M × 200 bytes = 200 MB                     │
│     С Flyweight:   1M × 12 bytes + 50 × 200 = 12 MB           │
└─────────────────────────────────────────────────────────────────┘
```

## ⚠️ Проблемы и решения

```
┌─────────────────────────────────────────────────────────────────┐
│                  ТИПИЧНЫЕ ПРОБЛЕМЫ И РЕШЕНИЯ                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┬───────────────────────────────────────────────┐
│   OVERHEAD      │  РЕШЕНИЕ:                                     │
│   FACTORY       │  • Используйте только для heavy objects       │
│                 │  • Lazy initialization                        │
│   Factory map   │  • Weak pointers для auto-cleanup             │
│   растет        │  • Периодическая очистка неиспользуемых       │
├─────────────────┼───────────────────────────────────────────────┤
│   THREAD        │  РЕШЕНИЕ:                                     │
│   SAFETY        │  • std::mutex для защиты factory map          │
│                 │  • Lock-free structures (advanced)            │
│   Конкурентный  │  • Thread-local flyweight pools               │
│   доступ к      │  • Read-write lock для оптимизации            │
│   factory       │                                               │
├─────────────────┼───────────────────────────────────────────────┤
│   IMMUTABILITY  │  РЕШЕНИЕ:                                     │
│                 │  • Flyweight должен быть immutable            │
│   Изменение     │  • const методы                               │
│   разделяемого  │  • const members                              │
│   состояния     │  • Документация об ограничениях               │
├─────────────────┼───────────────────────────────────────────────┤
│   MEMORY LEAK   │  РЕШЕНИЕ:                                     │
│                 │  • std::weak_ptr вместо shared_ptr            │
│   Flyweight'ы   │  • Периодическая очистка unused flyweights    │
│   не удаляются  │  • Expiration policy                          │
│                 │  • Reference counting monitoring              │
└─────────────────┴───────────────────────────────────────────────┘
```

## 📊 Метрики и мониторинг

```
┌─────────────────────────────────────────────────────────────────┐
│                   КЛЮЧЕВЫЕ МЕТРИКИ FLYWEIGHT                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  💾 ПАМЯТЬ                                                      │
│  • Total flyweights: количество уникальных flyweights           │
│  • Total objects: общее количество объектов                     │
│  • Sharing ratio: objects / flyweights                          │
│  • Memory saved: экономия памяти                                │
│  • Peak flyweights: максимум одновременно                       │
├─────────────────────────────────────────────────────────────────┤
│  📈 ПРОИЗВОДИТЕЛЬНОСТЬ                                          │
│  • Factory hit rate: % попаданий в cache                        │
│  • Factory miss rate: % создания новых                          │
│  • Lookup latency: время поиска flyweight                       │
│  • Creation latency: время создания нового                      │
├─────────────────────────────────────────────────────────────────┤
│  🔍 ЭФФЕКТИВНОСТЬ                                               │
│  • Average sharing: среднее число ссылок на flyweight           │
│  • Unused flyweights: flyweights без ссылок                     │
│  • Memory per object: память на объект                          │
│  • Fragmentation: фрагментация памяти                          │
└─────────────────────────────────────────────────────────────────┘

ПРИМЕР РАСЧЕТА ЭКОНОМИИ:
Without Flyweight: 10,000 × 95 bytes = 950 KB
With Flyweight:    10,000 × 17 bytes + 50 × 86 bytes = 174 KB
Savings: (950 - 174) / 950 = 81.7% 🚀
```

## 🎓 Best Practices

```
┌─────────────────────────────────────────────────────────────────┐
│                      ЛУЧШИЕ ПРАКТИКИ                           │
└─────────────────────────────────────────────────────────────────┘

✅ DO (Рекомендуется):
┌─────────────────────────────────────────────────────────────────┐
│ 1. Делайте Flyweight объекты IMMUTABLE                         │
│    class CharacterStyle {                                       │
│        const std::string font_;  // const!                      │
│        const int size_;          // const!                      │
│    };                                                           │
│                                                                 │
│ 2. Используйте для объектов с БОЛЬШИМ разделяемым состоянием  │
│    • Текстуры, шрифты, стили                                   │
│    • Материалы, шейдеры                                        │
│                                                                 │
│ 3. Правильно выбирайте ключ для Factory                        │
│    • Уникальный для каждой комбинации                          │
│    • Эффективный для hash/comparison                           │
│                                                                 │
│ 4. Используйте std::shared_ptr                                 │
│    • Автоматическое управление памятью                         │
│    • Thread-safe reference counting                            │
│                                                                 │
│ 5. Мониторьте sharing ratio                                    │
│    • Если ratio < 10, Flyweight может не окупаться            │
└─────────────────────────────────────────────────────────────────┘

❌ DON'T (Не рекомендуется):
┌─────────────────────────────────────────────────────────────────┐
│ 1. НЕ используйте для легковесных объектов                     │
│    ❌ Flyweight для int или char (overhead > выгода)           │
│                                                                 │
│ 2. НЕ делайте Flyweight mutable                                │
│    ❌ Изменение разделяемого состояния → все изменятся         │
│                                                                 │
│ 3. НЕ храните extrinsic state в Flyweight                      │
│    ❌ Position в Flyweight → не разделяется правильно          │
│                                                                 │
│ 4. НЕ игнорируйте thread safety                                │
│    ❌ Factory без mutex → race conditions                      │
│                                                                 │
│ 5. НЕ забывайте про overhead Factory                           │
│    ❌ Map lookup может быть дороже чем копирование             │
└─────────────────────────────────────────────────────────────────┘
```

## 🚀 Когда использовать Flyweight

```
┌─────────────────────────────────────────────────────────────────┐
│                    КОГДА ИСПОЛЬЗОВАТЬ                          │
└─────────────────────────────────────────────────────────────────┘

✅ ПОДХОДИТ ДЛЯ:
  • Много объектов с дублирующимся состоянием
  • Объекты с четким разделением intrinsic/extrinsic
  • Память критичный ресурс
  • Разделяемое состояние > уникальное состояние
  • Immutable objects (шрифты, текстуры, стили)
  • High sharing ratio (100+ объектов на 1 flyweight)

❌ НЕ ПОДХОДИТ ДЛЯ:
  • Мало объектов (< 100)
  • Уникальное состояние > разделяемое
  • Mutable shared state
  • Объекты создаются редко
  • Overhead Factory > экономия памяти
  • Low sharing ratio (< 10 объектов на flyweight)
```

## 📚 Связанные паттерны

```
┌─────────────────────────────────────────────────────────────────┐
│                   СВЯЗАННЫЕ ПАТТЕРНЫ                           │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┬───────────────────────────────────────────────┐
│  Object Pool    │  • Переиспользование объектов                 │
│                 │  • Pool для lifecycle, Flyweight для state    │
│                 │  • Часто используются вместе                  │
├─────────────────┼───────────────────────────────────────────────┤
│  Factory        │  • Flyweight Factory - специализация Factory  │
│                 │  • Управление созданием flyweights            │
│                 │  • Кэширование созданных объектов             │
├─────────────────┼───────────────────────────────────────────────┤
│  Singleton      │  • Factory часто реализован как Singleton     │
│                 │  • Глобальный доступ к flyweights             │
│                 │  • Единственный менеджер flyweights           │
├─────────────────┼───────────────────────────────────────────────┤
│  Composite      │  • Flyweight для листовых узлов               │
│                 │  • Разделяемые компоненты дерева              │
│                 │  • Экономия памяти в больших структурах       │
└─────────────────┴───────────────────────────────────────────────┘
```

## 💼 Пример: Игровой движок

```
┌─────────────────────────────────────────────────────────────────┐
│           FLYWEIGHT В ИГРОВОМ ДВИЖКЕ (Particles)               │
└─────────────────────────────────────────────────────────────────┘

БЕЗ FLYWEIGHT:
┌─────────────────────────────────────────────────────────────────┐
│ struct Particle {                                               │
│     // Intrinsic (разделяемое)                                 │
│     Texture texture;           // 8 MB!                         │
│     Shader shader;             // 100 KB                        │
│     Material material;         // 50 KB                         │
│                                                                 │
│     // Extrinsic (уникальное)                                  │
│     Vector3 position;          // 12 bytes                      │
│     Vector3 velocity;          // 12 bytes                      │
│     float rotation;            // 4 bytes                       │
│ };                                                              │
│                                                                 │
│ 100,000 частиц × 8.15 MB = 815 GB! 💥 Невозможно!            │
└─────────────────────────────────────────────────────────────────┘

С FLYWEIGHT:
┌─────────────────────────────────────────────────────────────────┐
│ // Flyweight (разделяемое)                                      │
│ struct ParticleType {                                           │
│     Texture texture;           // 8 MB                          │
│     Shader shader;             // 100 KB                        │
│     Material material;         // 50 KB                         │
│ };                                                              │
│                                                                 │
│ // Частица (уникальное)                                        │
│ struct Particle {                                               │
│     std::shared_ptr<ParticleType> type;  // 8 bytes            │
│     Vector3 position;          // 12 bytes                      │
│     Vector3 velocity;          // 12 bytes                      │
│     float rotation;            // 4 bytes                       │
│ };                                                              │
│                                                                 │
│ // 10 типов частиц                                             │
│ 10 types × 8.15 MB = 81.5 MB (flyweights)                      │
│ 100,000 частиц × 36 bytes = 3.6 MB (particles)                │
│ Итого: 85.1 MB vs 815 GB = 9,500x МЕНЬШЕ! 🚀                  │
└─────────────────────────────────────────────────────────────────┘
```

---

**Автор**: Senior C++ Developer  
**Дата**: 2025-10-07  
**Версия**: 1.0
