# 📊 Плакат: Proxy Pattern (Прокси)

## 🎯 Назначение Proxy Pattern

```
┌─────────────────────────────────────────────────────────────────┐
│                    PROXY PATTERN                               │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  🛡️ КОНТРОЛИРУЕТ ДОСТУП К ОБЪЕКТУ                           │
│  🔄 ЗАМЕЩАЕТ ОБЪЕКТ ДЛЯ КОНТРОЛЯ ВЗАИМОДЕЙСТВИЯ               │
│  🚀 ОТЛОЖЕННАЯ ИНИЦИАЛИЗАЦИЯ И КЭШИРОВАНИЕ                   │
│  🎯 ПРОЗРАЧНОСТЬ ДЛЯ КЛИЕНТА                                  │
└─────────────────────────────────────────────────────────────────┘

Применение:
┌─────────────────┬───────────────────────────────────────────────┐
│   Virtual Proxy │ • Отложенная загрузка объектов               │
├─────────────────┼───────────────────────────────────────────────┤
│   Remote Proxy  │ • Удаленные вызовы                           │
├─────────────────┼───────────────────────────────────────────────┤
│   Cache Proxy   │ • Кэширование результатов                    │
├─────────────────┼───────────────────────────────────────────────┤
│   Protection    │ • Контроль доступа                            │
│   Proxy         │                                               │
├─────────────────┼───────────────────────────────────────────────┤
│   Smart Proxy   │ • Дополнительные операции                    │
└─────────────────┴───────────────────────────────────────────────┘
```

## 🔄 Проблема без Proxy

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПРОБЛЕМА: НЕЭФФЕКТИВНОСТЬ                   │
└─────────────────────────────────────────────────────────────────┘

❌ ПЛОХОЙ ДИЗАЙН - Нарушение принципов:
┌─────────────────────────────────────────────────────────────────┐
│                    Client (Нарушает принципы)                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              Client                                        ││
│  │                                                             ││
│  │  void loadImage(const std::string& filename) {            ││
│  │      // ❌ ПРОБЛЕМЫ:                                      ││
│  │      // • Медленная загрузка                               ││
│  │      // • Нет кэширования                                  ││
│  │      // • Нет контроля доступа                             ││
│  │      // • Нет ленивой инициализации                        ││
│  │                                                             ││
│  │      Image image(filename);  // Медленно!                  ││
│  │      image.display();                                       ││
│  │      image.resize(800, 600);                               ││
│  │      image.display();                                       ││
│  │                                                             ││
│  │      // Повторная загрузка того же изображения             ││
│  │      Image image2(filename);  // Еще медленнее!            ││
│  │      image2.display();                                     ││
│  │  }                                                          ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  Проблемы:                                                     │
│  ❌ Медленная загрузка изображений                             │
│  ❌ Отсутствие кэширования                                     │
│  ❌ Нет контроля доступа                                       │
│  ❌ Нет ленивой инициализации                                  │
└─────────────────────────────────────────────────────────────────┘
```

## ✅ Решение с Proxy

```
┌─────────────────────────────────────────────────────────────────┐
│                    РЕШЕНИЕ: PROXY PATTERN                     │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    ХОРОШИЙ ДИЗАЙН                             │
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │   Image     │    │ ImageProxy  │    │   Client    │        │
│  │             │    │             │    │             │        │
│  │ • display() │    │ • display() │    │ • load()    │        │
│  │ • resize()  │    │ • resize()  │    │ • use()     │        │
│  │ • load()    │    │ • load()    │    │             │        │
│  └─────────────┘    └─────────────┘    └─────────────┘        │
│         ▲                 ▲                 ▲                  │
│         │                 │                 │                  │
│  ┌──────┴─────────────────┴─────────────────┴──────────┐      │
│  │              ImageProxy                              │      │
│  │                                                     │      │
│  │  std::unique_ptr<Image> realImage;                 │      │
│  │  std::string filename;                              │      │
│  │  static std::unordered_map<std::string, Image> cache;│      │
│  │                                                     │      │
│  │  void display() {                                  │      │
│  │      if (!realImage) {                             │      │
│  │          // Ленивая инициализация                  │      │
│  │          if (cache.find(filename) != cache.end()) {│      │
│  │              realImage = std::make_unique<Image>(cache[filename]);│      │
│  │          } else {                                  │      │
│  │              realImage = std::make_unique<Image>(filename);│      │
│  │              cache[filename] = *realImage;         │      │
│  │          }                                         │      │
│  │      }                                              │      │
│  │      realImage->display();                          │      │
│  │  }                                                  │      │
│  └─────────────────────────────────────────────────────┘      │
│                                                                 │
│  Преимущества:                                                  │
│  ✅ Ленивая инициализация                                       │
│  ✅ Кэширование изображений                                     │
│  ✅ Контроль доступа                                            │
│  ✅ Прозрачность для клиента                                    │
└─────────────────────────────────────────────────────────────────┘
```

## 🏗️ Структура Proxy Pattern

```
┌─────────────────────────────────────────────────────────────────┐
│                    СТРУКТУРА ПАТТЕРНА                          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    Subject (Субъект)                           │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Subject                                ││
│  │                                                             ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        ││
│  │  │ Real        │  │ Proxy       │  │ Client      │        ││
│  │  │ Subject     │  │             │  │             │        ││
│  │  │             │  │             │  │             │        ││
│  │  │ • request() │  │ • request() │  │ • use()     │        ││
│  │  │ • operation │  │ • operation │  │ • call()    │        ││
│  │  └─────────────┘  └─────────────┘  └─────────────┘        ││
│  │         ▲                 ▲                 ▲              ││
│  │         │                 │                 │              ││
│  │  ┌──────┴─────────────────┴─────────────────┴──────────┐  ││
│  │  │              Subject                               │  ││
│  │  │                                                     │  ││
│  │  │  virtual void request() = 0;                        │  ││
│  │  │  virtual void operation() = 0;                      │  ││
│  │  └─────────────────────────────────────────────────────┘  ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 Последовательность взаимодействий

```
┌─────────────────────────────────────────────────────────────────┐
│              ПОСЛЕДОВАТЕЛЬНОСТЬ ВЗАИМОДЕЙСТВИЙ                │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    1. СОЗДАНИЕ ПРОКСИ                          │
│                                                                 │
│  ┌─────────────┐              ┌─────────────┐                 │
│  │   Client    │              │    Proxy    │                 │
│  │             │              │             │                 │
│  │ • create()  │              │ • request() │                 │
│  │ • use()     │              │ • operation │                 │
│  └─────────────┘              └─────────────┘                 │
│         │                              ▲                      │
│         │                              │                      │
│         │      new Proxy()             │                      │
│         └──────────────────────────────┘                      │
│                                                                 │
│                    2. ВЫПОЛНЕНИЕ ЗАПРОСА                       │
│                                                                 │
│  ┌─────────────┐              ┌─────────────┐                 │
│  │   Client    │              │    Proxy    │                 │
│  │             │              │             │                 │
│  │ • request() │              │ • request() │                 │
│  │             │              │ • operation │                 │
│  └─────────────┘              └─────────────┘                 │
│         │                              ▲                      │
│         │                              │                      │
│         │      request()               │                      │
│         └──────────────────────────────┘                      │
│                                                                 │
│                    3. ДЕЛЕГИРОВАНИЕ К РЕАЛЬНОМУ ОБЪЕКТУ       │
│                                                                 │
│  ┌─────────────┐              ┌─────────────┐                 │
│  │    Proxy    │              │ Real Subject │                 │
│  │             │              │             │                 │
│  │ • request() │              │ • request() │                 │
│  │ • operation │              │ • operation │                 │
│  └─────────────┘              └─────────────┘                 │
│         │                              ▲                      │
│         │                              │                      │
│         │      realSubject->request()   │                      │
│         └──────────────────────────────┘                      │
└─────────────────────────────────────────────────────────────────┘
```

## 🎨 Варианты реализации

### 1. Virtual Proxy (Виртуальный прокси)
```
┌─────────────────────────────────────────────────────────────────┐
│                  VIRTUAL PROXY                                │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ class Image {                                                   │
│ public:                                                          │
│     Image(const std::string& filename) {                        │
│         // Медленная загрузка изображения                       │
│         loadFromFile(filename);                                 │
│     }                                                            │
│                                                                  │
│     void display() {                                             │
│         // Отображение изображения                              │
│     }                                                            │
│ };                                                               │
│                                                                  │
│ class ImageProxy {                                               │
│ private:                                                         │
│     std::unique_ptr<Image> realImage;                            │
│     std::string filename;                                        │
│                                                                  │
│ public:                                                          │
│     ImageProxy(const std::string& filename)                     │
│         : filename(filename) {}                                 │
│                                                                  │
│     void display() {                                             │
│         if (!realImage) {                                        │
│             // Ленивая инициализация                             │
│             realImage = std::make_unique<Image>(filename);       │
│         }                                                        │
│         realImage->display();                                    │
│     }                                                            │
│ };                                                               │
└─────────────────────────────────────────────────────────────────┘
```

### 2. Cache Proxy (Кэш-прокси)
```
┌─────────────────────────────────────────────────────────────────┐
│                  CACHE PROXY                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ class CacheProxy {                                              │
│ private:                                                        │
│     std::unique_ptr<Image> realImage;                           │
│     std::string filename;                                       │
│     static std::unordered_map<std::string, Image> cache;       │
│                                                                 │
│ public:                                                         │
│     CacheProxy(const std::string& filename)                     │
│         : filename(filename) {}                                │
│                                                                 │
│     void display() {                                           │
│         if (!realImage) {                                       │
│             // Проверяем кэш                                    │
│             if (cache.find(filename) != cache.end()) {         │
│                 realImage = std::make_unique<Image>(cache[filename]);│
│             } else {                                            │
│                 // Загружаем и кэшируем                        │
│                 realImage = std::make_unique<Image>(filename);   │
│                 cache[filename] = *realImage;                   │
│             }                                                   │
│         }                                                       │
│         realImage->display();                                  │
│     }                                                           │
│ };                                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 3. Protection Proxy (Защитный прокси)
```
┌─────────────────────────────────────────────────────────────────┐
│                  PROTECTION PROXY                              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ class ProtectionProxy {                                        │
│ private:                                                        │
│     std::unique_ptr<Image> realImage;                           │
│     std::string filename;                                       │
│     std::string userRole;                                       │
│                                                                 │
│ public:                                                         │
│     ProtectionProxy(const std::string& filename,                │
│                     const std::string& role)                    │
│         : filename(filename), userRole(role) {}                │
│                                                                 │
│     void display() {                                           │
│         if (userRole == "admin" || userRole == "user") {       │
│             if (!realImage) {                                   │
│                 realImage = std::make_unique<Image>(filename);  │
│             }                                                   │
│             realImage->display();                               │
│         } else {                                                │
│             throw std::runtime_error("Access denied");          │
│         }                                                       │
│     }                                                           │
│ };                                                              │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 Сравнение подходов

```
┌─────────────────────────────────────────────────────────────────┐
│                    СРАВНЕНИЕ ПОДХОДОВ                          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐
│   Virtual        │   Cache         │   Protection    │   Remote        │
├─────────────────┼─────────────────┼─────────────────┼─────────────────┤
│ Простота        │ Средняя         │ Высокая         │ Низкая          │
│ Производительность│ Высокая        │ Очень высокая   │ Высокая         │
│ Безопасность    │ Высокая         │ Высокая         │ Очень высокая   │
│ Гибкость        │ Высокая         │ Высокая         │ Высокая         │
│ Тестируемость   │ Высокая         │ Высокая         │ Высокая         │
│ Применимость    │ Общие случаи    │ Частые запросы  │ Контроль доступа│
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
```

## 🎯 Когда использовать Proxy

```
┌─────────────────────────────────────────────────────────────────┐
│                КОГДА ИСПОЛЬЗОВАТЬ PROXY                       │
└─────────────────────────────────────────────────────────────────┘

✅ ХОРОШИЕ СЛУЧАИ:
┌─────────────────┬───────────────────────────────────────────────┐
│ Virtual Proxy   │ • Отложенная загрузка объектов               │
│                 │ • Ленивая инициализация                      │
│                 │ • Экономия ресурсов                          │
├─────────────────┼───────────────────────────────────────────────┤
│ Cache Proxy     │ • Кэширование результатов                    │
│                 │ • Ускорение повторных запросов               │
│                 │ • Экономия вычислений                        │
├─────────────────┼───────────────────────────────────────────────┤
│ Protection      │ • Контроль доступа                            │
│ Proxy           │ • Аутентификация и авторизация               │
│                 │ • Безопасность данных                        │
├─────────────────┼───────────────────────────────────────────────┤
│ Remote Proxy    │ • Удаленные вызовы                           │
│                 │ • Сетевые операции                           │
│                 │ • Распределенные системы                     │
├─────────────────┼───────────────────────────────────────────────┤
│ Smart Proxy     │ • Дополнительные операции                    │
│                 │ • Логирование и мониторинг                   │
│                 │ • Управление ресурсами                       │
└─────────────────┴───────────────────────────────────────────────┘

❌ ПЛОХИЕ СЛУЧАИ:
┌─────────────────┬───────────────────────────────────────────────┐
│ Простые случаи  │ • Когда нет необходимости в контроле          │
│                 │ • Когда объект не дорогой                    │
├─────────────────┼───────────────────────────────────────────────┤
│ Производительность│ • Когда критична производительность          │
│                 │ • Когда накладные расходы недопустимы         │
├─────────────────┼───────────────────────────────────────────────┤
│ Сложность       │ • Когда усложнение не оправдано              │
│                 │ • Когда можно использовать простые решения    │
└─────────────────┴───────────────────────────────────────────────┘
```

## 🧪 Тестирование Proxy

```
┌─────────────────────────────────────────────────────────────────┐
│                    ТЕСТИРОВАНИЕ PROXY                         │
└─────────────────────────────────────────────────────────────────┘

Тестирование виртуального прокси:
┌─────────────────────────────────────────────────────────────────┐
│ TEST(ProxyTest, VirtualProxy) {                                │
│     ImageProxy proxy("test.jpg");                              │
│                                                                 │
│     // Первый вызов должен создать реальный объект            │
│     EXPECT_NO_THROW(proxy.display());                          │
│                                                                 │
│     // Второй вызов должен использовать существующий объект    │
│     EXPECT_NO_THROW(proxy.display());                          │
│ }                                                               │
└─────────────────────────────────────────────────────────────────┘

Тестирование кэш-прокси:
┌─────────────────────────────────────────────────────────────────┐
│ TEST(ProxyTest, CacheProxy) {                                  │
│     CacheProxy proxy1("test.jpg");                             │
│     CacheProxy proxy2("test.jpg");                             │
│                                                                 │
│     // Первый прокси загружает изображение                     │
│     proxy1.display();                                          │
│                                                                 │
│     // Второй прокси использует кэш                            │
│     EXPECT_NO_THROW(proxy2.display());                         │
│ }                                                               │
└─────────────────────────────────────────────────────────────────┘

Тестирование защитного прокси:
┌─────────────────────────────────────────────────────────────────┐
│ TEST(ProxyTest, ProtectionProxy) {                             │
│     ProtectionProxy adminProxy("test.jpg", "admin");          │
│     ProtectionProxy userProxy("test.jpg", "user");             │
│     ProtectionProxy guestProxy("test.jpg", "guest");           │
│                                                                 │
│     // Админ и пользователь могут получить доступ              │
│     EXPECT_NO_THROW(adminProxy.display());                     │
│     EXPECT_NO_THROW(userProxy.display());                       │
│                                                                 │
│     // Гость не может получить доступ                          │
│     EXPECT_THROW(guestProxy.display(), std::runtime_error);    │
│ }                                                               │
└─────────────────────────────────────────────────────────────────┘
```

## 🔗 Связь с другими паттернами

```
┌─────────────────────────────────────────────────────────────────┐
│              СВЯЗЬ С ДРУГИМИ ПАТТЕРНАМИ                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┬───────────────────────────────────────────────┐
│ Adapter         │ • Proxy - контроль доступа                   │
│                 │ • Adapter - адаптация интерфейса             │
│                 │ • Proxy - замещение объекта                   │
│                 │ • Adapter - совместимость интерфейсов        │
├─────────────────┼───────────────────────────────────────────────┤
│ Decorator       │ • Proxy - контроль доступа                   │
│                 │ • Decorator - добавление функциональности     │
│                 │ • Proxy - замещение объекта                   │
│                 │ • Decorator - расширение поведения            │
├─────────────────┼───────────────────────────────────────────────┤
│ Facade          │ • Proxy - контроль доступа                    │
│                 │ • Facade - упрощение интерфейса              │
│                 │ • Proxy - замещение объекта                   │
│                 │ • Facade - скрытие сложности                  │
├─────────────────┼───────────────────────────────────────────────┤
│ Command         │ • Proxy может использовать Command           │
│                 │ • Контроль выполнения команд                 │
│                 │ • Отложенное выполнение                      │
└─────────────────┴───────────────────────────────────────────────┘
```

## 💡 Практические рекомендации

```
┌─────────────────────────────────────────────────────────────────┐
│                  ПРАКТИЧЕСКИЕ РЕКОМЕНДАЦИИ                     │
└─────────────────────────────────────────────────────────────────┘

1. 🎯 Выбор типа прокси:
   • Virtual - для отложенной загрузки
   • Cache - для кэширования
   • Protection - для контроля доступа
   • Remote - для удаленных вызовов

2. 🔧 Принципы проектирования:
   • Прозрачность для клиента
   • Контроль доступа к объекту
   • Инкапсуляция сложности
   • Разделение ответственности

3. 🧪 Тестирование:
   • Тестируйте прокси как единое целое
   • Используйте моки для изоляции тестов
   • Проверяйте корректность делегирования
   • Тестируйте обработку ошибок

4. ⚠️ Типичные ошибки:
   • Создание слишком сложного прокси
   • Игнорирование производительности
   • Неправильное управление состоянием
   • Отсутствие валидации входных данных

5. 📚 Лучшие практики:
   • Используйте RAII для управления ресурсами
   • Применяйте move semantics
   • Документируйте поведение прокси
   • Рассмотрите асинхронные операции

6. 🚀 Оптимизация:
   • Кэшируйте часто используемые объекты
   • Используйте move semantics
   • Рассмотрите lazy loading
   • Профилируйте критические участки
```

## 🎓 Ключевые выводы

```
┌─────────────────────────────────────────────────────────────────┐
│                      КЛЮЧЕВЫЕ ВЫВОДЫ                          │
└─────────────────────────────────────────────────────────────────┘

✅ Proxy - мощный паттерн для контроля:
   • Контроль доступа к объектам
   • Отложенная инициализация
   • Кэширование результатов
   • Прозрачность для клиента

✅ Выбирайте подходящий тип:
   • Virtual - отложенная загрузка
   • Cache - кэширование
   • Protection - контроль доступа
   • Remote - удаленные вызовы

✅ Используйте правильно:
   • Когда нужен контроль доступа
   • Для отложенной инициализации
   • Для кэширования результатов
   • Для удаленных вызовов

✅ Избегайте злоупотребления:
   • Не используйте для простых случаев
   • Не создавайте слишком сложный прокси
   • Не игнорируйте производительность
   • Не забывайте об управлении ресурсами

✅ Интеграция с паттернами:
   • Альтернатива Adapter
   • Комбинация с Decorator
   • Использование в Facade
   • Основа для Command
```

---
*Proxy Pattern - это ключ к контролю и оптимизации. Используйте его для создания эффективных и безопасных систем!*
